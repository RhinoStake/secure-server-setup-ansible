---
# Berachain Erigon
# Port prefix is 254
# Erigon: 25403/tcp/udp, 25445 rpc

- name: Register public ip
  ansible.builtin.uri:
    url: https://ipv4.icanhazip.com/
    return_content: true
  register: public_ip

- name: Create a network
  community.docker.docker_network:
    name: berachain_net

- name: Create erigon-data folder
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  with_items:
    - "{{ user_dir }}/docker-compose/berachain-data"
    - "{{ user_dir }}/docker-compose/berachain-config"

- name: Copy berachain genesis
  ansible.builtin.copy:
    src: "files/eth-genesis.json"
    dest: "{{ user_dir }}/docker-compose/berachain-config/eth-genesis.json"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"

- name: Init erigon container
  community.docker.docker_container:
    name: erigon-init
    image: thorax/erigon:v2.60.0
    command: init --datadir=/erigon-data /erigon-config/eth-genesis.json
    pull: true
    volumes:
      - "{{ user_dir }}/docker-compose/berachain-data:/erigon-data"
      - "{{ user_dir }}/docker-compose/berachain-config:/erigon-config"
    user: 1000:1000
    networks:
      - name: berachain_net
    state: started

- name: Run erigon container
  community.docker.docker_container:
    name: erigon
    image: thorax/erigon:v2.60.0
    restart_policy: unless-stopped
    state: started
    pull: true
    stop_timeout: 600
    networks:
      - name: berachain_net
    ports:
      # p2p
      - 25403:25403/tcp
      - 25403:25403/udp
      # rpc
      - "{{ nebula_internal_ip_addr }}:25445:8545"
      - 127.0.0.1:25445:8545
      - "{{ nebula_internal_ip_addr }}:25446:8546"
      - 127.0.0.1:25446:8546
      - 0.0.0.0:25451:8551
    volumes:
      - "{{ user_dir }}/docker-compose/berachain-data:/erigon-data"
      - "{{ user_dir }}/.beacond/config/jwt.hex:/jwt.hex"
    user: 1000:1000
    command:
      - --datadir=/erigon-data
      - --port=25403
      - --networkid=80084
      # - --snapshots=false
      # RPC
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.vhosts=*
      - --http.corsdomain=*
      - --authrpc.addr=0.0.0.0
      - --authrpc.port=8551
      - --authrpc.vhosts=*
      - --authrpc.jwtsecret=/jwt.hex
      - --http
      - --ws
      - --ws.port=8546
      - --http.api=eth,debug,net,trace,web3,erigon
      - --metrics
      - --metrics.addr=0.0.0.0
      - --metrics.port=6060
      - --nat=extip:{{ public_ip.content | trim }}
      - --bootnodes=enode://0401e494dbd0c84c5c0f72adac5985d2f2525e08b68d448958aae218f5ac8198a80d1498e0ebec2ce38b1b18d6750f6e61a56b4614c5a6c6cf0981c39aed47dc@34.159.32.127:30303,enode://9b6c1eb143c9e3af0c7283262a9a38fe8bf844114b1f304673c2ac1c23e6bccfdaa8f4e9cb8c460bded495933fd92eeff30e6ab2e0538b56e249beea2c512906@35.234.88.149:30303
