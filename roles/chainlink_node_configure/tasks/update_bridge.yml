---
- name: Create docker-compose directory
  ansible.builtin.file:
    path: "{{ user_dir }}/docker-compose"
    state: directory
    mode: "0755"

- name: Copy docker-compose files
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ user_dir }}/docker-compose/"
    mode: "0644"
  with_fileglob:
    - "templates/adapters/.env"
    - "templates/adapters/docker-compose.yml"
  notify: Grafana bridge update

- name: Run authentication for docker connecting to ecr
  ansible.builtin.shell: "aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 384718691752.dkr.ecr.us-east-1.amazonaws.com"
  environment:
    PATH: "{{ path }}"

- name: Update and launch containers
  community.docker.docker_compose:
    project_src: "{{ user_dir }}/docker-compose"
    pull: true
    state: present

- name: Prune everything
  community.docker.docker_prune:
    containers: true
    images: true
    images_filters:
      dangling: false
  register: prune_output

- name: Review prune output
  ansible.builtin.debug:
    var: prune_output
