---
- name: Create docker-compose directory
  ansible.builtin.file:
    path: "{{ user_dir }}/docker-compose"
    state: directory
    mode: "0755"

- name: Copy docker-compose files
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "{{ user_dir }}/docker-compose/"
    mode: "0644"
  with_fileglob:
    - "templates/adapters/.env"
    - "templates/adapters/docker-compose.yml"
  notify: Grafana bridge update

- name: Get instance AWS profile info
  amazon.aws.aws_caller_info:
  register: aws_info

- name: Set account info fact
  ansible.builtin.set_fact:
    ecr_registry_url: "{{ aws_info.account }}.dkr.ecr.us-east-1.amazonaws.com"

- name: Get ECR token
  ansible.builtin.shell: "aws ecr get-login-password --region us-east-1"
  register: ecr_token
  environment:
    PATH: "{{ path }}"

- name: Log into ECR registry
  community.docker.docker_login:
    registry_url: "{{ ecr_registry_url }}"
    debug: true
    username: "AWS"
    password: "{{ ecr_token.stdout }}"
    reauthorize: true

- name: Pull containers
  ansible.builtin.command:
    cmd: "docker compose pull"
  args:
    chdir: "{{ user_dir }}/docker-compose"
  environment:
    PATH: "{{ path }}"

- name: Update and launch containers
  ansible.builtin.command:
    cmd: "docker compose up -d"
  args:
    chdir: "{{ user_dir }}/docker-compose"
  environment:
    PATH: "{{ path }}"

- name: Prune everything
  community.docker.docker_prune:
    containers: true
    images: true
    images_filters:
      dangling: false
  register: prune_output

- name: Review prune output
  ansible.builtin.debug:
    var: prune_output
