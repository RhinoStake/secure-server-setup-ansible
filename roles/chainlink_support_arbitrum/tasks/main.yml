---
# Arbitrum support structure with host networking
# Ports:
#  - Nitro: 8547/tcp (rpc), 9642 (sequencer)

- name: Create and adjust permissions on arbitrum data folder
  become: true
  ansible.builtin.file:
    dest: "{{ item }}"
    state: directory
    mode: "0755"
    recurse: true
  loop:
    - "{{ user_dir }}/docker-compose/arbitrum"
    - "{{ user_dir }}/docker-compose/tmp"

- name: Pull and run nitro container
  community.docker.docker_container:
    name: arbitrum
    image: offchainlabs/nitro-node:{{ nitro_version }}
    restart_policy: unless-stopped
    state: started
    network_mode: host
    stop_timeout: 600
    pull: true
    volumes:
      - "{{ user_dir }}/docker-compose/arbitrum:/home/user/.arbitrum"
      - "{{ user_dir }}/docker-compose/tmp:/tmp"
    command:
      - --parent-chain.connection.url={{ ethereum_l1 }}
      - --parent-chain.blob-client.beacon-url={{ ethereum_l1_beacon }}
      - --chain.name=arb1
      - --http.port=8547
      - --http.addr=0.0.0.0
      - --http.vhosts=*
      - --http.corsdomain=*
      - --http.api=net,web3,eth,arb
      - --ws.port=8548
      - --ws.addr=0.0.0.0
      - --ws.origins=*
      - --execution.rpc.gas-cap=0
      - --execution.rpc.tx-fee-cap=0
      - --init.url=https://snapshot.arbitrum.foundation/arb1/nitro-pruned.tar
      - --node.staker.enable=false # Remove watchtower mode
      - --rpc.max-batch-response-size=200000000 # Per RMN Documentation
      # - --init.prune=full # Prune at startup

- name: Prune unused docker containers and images
  community.docker.docker_prune:
    containers: true
    images: true
    networks: true
    volumes: true
    builder_cache: true
  register: prune_output

- name: Review prune output
  ansible.builtin.debug:
    var: prune_output
