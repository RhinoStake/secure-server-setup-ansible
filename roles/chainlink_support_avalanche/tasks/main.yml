---
# Avalanche structure with host networking
# Ports:
#  - avalanchego: 9651 (p2p - public), 9650 (rpc)

- name: Register public ip
  ansible.builtin.uri:
    url: https://ipv4.icanhazip.com/
    return_content: true
  register: public_ip

- name: Open p2p ports for avalanchego
  become: true
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
    comment: "{{ item.comment }}"
  loop:
    - port: 9651
      proto: any
      comment: External - avalanchego

- name: Create folder structure for data and config
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ user_dir }}/docker-compose/avalanchego-data"
    - "{{ user_dir }}/docker-compose/avalanchego-config"
    - "{{ user_dir }}/docker-compose/avalanchego-config/C"

- name: Copy C-Chain config for use
  become: true
  ansible.builtin.copy:
    src: files/C-config.json
    dest: "{{ user_dir }}/docker-compose/avalanchego-config/C/config.json"
    owner: "root"
    group: "root"
    mode: "0644"

- name: Create a network
  community.docker.docker_network:
    name: avax_net

- name: Run avalanchego container
  community.docker.docker_container:
    name: avalanchego
    image: avaplatform/avalanchego:{{ avalanchego_version }}
    restart_policy: unless-stopped
    state: started
    stop_timeout: 600
    pull: true
    networks:
      - name: avax_net
    ports:
      # p2p
      - 9651:9651/tcp
      # rpc
      - "{{ nebula_internal_ip_addr }}:9650:9650"
      - 127.0.0.1:9650:9650
    volumes:
      - "{{ user_dir }}/docker-compose/avalanchego-data:/avalanchego-data"
      - "{{ user_dir }}/docker-compose/avalanchego-config:/avalanchego-config"
      - /etc/localtime:/etc/localtime:ro
    command:
      - /avalanchego/build/avalanchego
      - --data-dir=/avalanchego-data
      - --chain-config-dir=/avalanchego-config
      - --http-host=0.0.0.0
      - --public-ip={{ public_ip.content | trim }}
      - --staking-port=9651
      - --log-level=info
