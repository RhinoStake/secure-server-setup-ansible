---
# Avalanche structure with host networking
# Ports:
#  - avalanchego: 9651 (p2p - public), 9650 (rpc)

- name: Open p2p ports for avalanchego
  become: true
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
    comment: "{{ item.comment }}"
  loop:
    - port: 9651
      proto: tcp
      comment: External - avalanchego

- name: Run avalanchego container
  community.docker.docker_container:
    name: avalanchego
    image: avaplatform/avalanchego:{{ avalanchego_version }}
    restart_policy: unless-stopped
    state: started
    stop_timeout: 600
    network_mode: host
    volumes:
      - "{{ user_dir }}/docker-compose/avalanchego-data:/avalanchego-data"
      - /etc/localtime:/etc/localtime:ro
    command:
      - /avalanchego/build/avalanchego
      - --data-dir=/avalanchego-data
      - --http-host=0.0.0.0
      - --log-level=info
      - --state-sync-enabled=false # Per RMN Documentation
