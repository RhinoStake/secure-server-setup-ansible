---
# Base with op-node, op-geth.  Utilized snap-sync for sync
# Base port prefix: 135
# Ports:
#  - Geth: 13503 (p2p - public), 13545 (rpc), 13546 (ws), 8551 (authrpc)
#  - Node: 13509 (p2p - public), 13549 (rpc)

- name: Register public ip
  ansible.builtin.uri:
    url: https://ipv4.icanhazip.com/
    return_content: true
  register: public_ip

- name: Ensure op-geth-data exists
  ansible.builtin.file:
    path: "{{ user_dir }}/docker-compose/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - base
    - base/op-geth-data
    - base/op-node-config

- name: Copy node config files
  ansible.builtin.copy:
    src: "files/{{ item }}"
    dest: "{{ user_dir }}/docker-compose/base/op-node-config/{{ item }}"
    mode: "0644"
  loop:
    - rollup.json

- name: Create jwtsecret if it does not exist
  ansible.builtin.shell: "openssl rand -hex 32 | tr -d '\n' > jwtsecret"
  args:
    chdir: "{{ user_dir }}/docker-compose"
    creates: jwtsecret
    executable: /bin/bash

- name: Create a network
  community.docker.docker_network:
    name: base_net

- name: Run base-op-geth container
  community.docker.docker_container:
    name: base-op-geth
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-geth:{{ base_geth_version }}
    restart_policy: unless-stopped
    state: started
    stop_timeout: 600
    pull: true
    networks:
      - name: base_net
    ports:
      # p2p
      - 13503:13503/tcp
      - 13503:13503/udp
      # rpc
      - 127.0.0.1:13545:8545
      - "{{ nebula_internal_ip_addr }}:13545:8545"
      - 127.0.0.1:13546:8546
      - "{{ nebula_internal_ip_addr }}:13546:8546"
      # metrics
      - 127.0.0.1:13560:6060
      - "{{ nebula_internal_ip_addr }}:13560:6060"
    volumes:
      - "{{ user_dir }}/docker-compose/base/op-geth-data:/op-geth-data"
      - "{{ user_dir }}/docker-compose/jwtsecret:/jwtsecret"
      - /etc/localtime:/etc/localtime:ro
    command:
      ## General
      - --datadir=/op-geth-data
      - --syncmode=snap
      - --bootnodes=enode://87a32fd13bd596b2ffca97020e31aef4ddcc1bbd4b95bb633d16c1329f654f34049ed240a36b449fda5e5225d70fe40bc667f53c304b71f8e68fc9d448690b51@3.231.138.188:30301,enode://ca21ea8f176adb2e229ce2d700830c844af0ea941a1d8152a9513b966fe525e809c3a6c73a2c18a12b74ed6ec4380edf91662778fe0b79f6a591236e49e176f9@184.72.129.189:30301,enode://acf4507a211ba7c1e52cdf4eef62cdc3c32e7c9c47998954f7ba024026f9a6b2150cd3f0b734d9c78e507ab70d59ba61dfe5c45e1078c7ad0775fb251d7735a2@3.220.145.177:30301,enode://8a5a5006159bf079d06a04e5eceab2a1ce6e0f721875b2a9c96905336219dbe14203d38f70f3754686a6324f786c2f9852d8c0dd3adac2d080f4db35efc678c5@3.231.11.52:30301,enode://cdadbe835308ad3557f9a1de8db411da1a260a98f8421d62da90e71da66e55e98aaa8e90aa7ce01b408a54e4bd2253d701218081ded3dbe5efbbc7b41d7cef79@54.198.153.150:30301
      - --op-network=base-mainnet
      ## Interfaces
      # Consensus Layer Engine API
      - --authrpc.addr=0.0.0.0
      - --authrpc.port=8551
      - --authrpc.vhosts=*
      - --authrpc.jwtsecret=/jwtsecret
      # HTTP/RPC
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.corsdomain=*"
      - --http.vhosts=*
      - --http.api=web3,debug,eth,txpool,net,engine
      # Websocket
      - --ws
      - --ws.addr=0.0.0.0
      - --ws.port=8546
      - --ws.origins=*
      - --ws.api=web3,debug,eth,txpool,net,engine
      # P2P
      - --port=13503
      - --discovery.port=13503
      - --nat=extip:{{ public_ip.content | trim }}
      # Metrics
      - --metrics
      - --metrics.addr=0.0.0.0
      - --metrics.port=6060
      - --metrics.expensive
      # Transaction & Chain Specific
      - --rollup.sequencerhttp=https://mainnet-sequencer.base.org
      - --rollup.disabletxpoolgossip=true
      - --rollup.halt=major
      - --rpc.gascap=0
      - --ipcdisable
      - --rpc.batch-response-max-size=70000000 # Per RMN Documentation
      - --rpc.txfeecap=0 # Per RMN Documentation

- name: Run base-op-node container
  community.docker.docker_container:
    name: base-op-node
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-node:{{ base_node_version }}
    restart_policy: unless-stopped
    state: started
    stop_timeout: 600
    pull: true
    networks:
      - name: base_net
    ports:
      # p2p
      - 13509:13509
      # rpc
      - 127.0.0.1:13549:9545
      - "{{ nebula_internal_ip_addr }}:13549:9545"
    volumes:
      - "{{ user_dir }}/docker-compose/jwtsecret:/jwtsecret"
      - "{{ user_dir }}/docker-compose/base/op-node-config/rollup.json:/rollup.json"
      - /etc/localtime:/etc/localtime:ro
    command:
      ## General
      - op-node
      - --l1={{ ethereum_l1 }}
      - --l1.beacon={{ ethereum_l1_beacon }}
      - --l1.trustrpc=true
      - --l2=http://base-op-geth:8551
      - --l2.jwt-secret=/jwtsecret
      - --network=base-mainnet
      - --rollup.load-protocol-versions=true
      - --rollup.config=/rollup.json
      - --rollup.load-protocol-versions=true
      # Syncing
      - --syncmode=execution-layer
      - --l1.max-concurrency=64
      - --l1.rpc-rate-limit=0
      - --l1.rpc-max-batch-size=500
      - --verifier.l1-confs=4
      # p2p
      - --p2p.advertise.ip={{ public_ip.content | trim }}
      - --p2p.listen.tcp=13509
      - --p2p.bootnodes=enr:-J24QNz9lbrKbN4iSmmjtnr7SjUMk4zB7f1krHZcTZx-JRKZd0kA2gjufUROD6T3sOWDVDnFJRvqBBo62zuF-hYCohOGAYiOoEyEgmlkgnY0gmlwhAPniryHb3BzdGFja4OFQgCJc2VjcDI1NmsxoQKNVFlCxh_B-716tTs-h1vMzZkSs1FTu_OYTNjgufplG4N0Y3CCJAaDdWRwgiQG,enr:-J24QH-f1wt99sfpHy4c0QJM-NfmsIfmlLAMMcgZCUEgKG_BBYFc6FwYgaMJMQN5dsRBJApIok0jFn-9CS842lGpLmqGAYiOoDRAgmlkgnY0gmlwhLhIgb2Hb3BzdGFja4OFQgCJc2VjcDI1NmsxoQJ9FTIv8B9myn1MWaC_2lJ-sMoeCDkusCsk4BYHjjCq04N0Y3CCJAaDdWRwgiQG,enr:-J24QDXyyxvQYsd0yfsN0cRr1lZ1N11zGTplMNlW4xNEc7LkPXh0NAJ9iSOVdRO95GPYAIc6xmyoCCG6_0JxdL3a0zaGAYiOoAjFgmlkgnY0gmlwhAPckbGHb3BzdGFja4OFQgCJc2VjcDI1NmsxoQJwoS7tzwxqXSyFL7g0JM-KWVbgvjfB8JA__T7yY_cYboN0Y3CCJAaDdWRwgiQG,enr:-J24QHmGyBwUZXIcsGYMaUqGGSl4CFdx9Tozu-vQCn5bHIQbR7On7dZbU61vYvfrJr30t0iahSqhc64J46MnUO2JvQaGAYiOoCKKgmlkgnY0gmlwhAPnCzSHb3BzdGFja4OFQgCJc2VjcDI1NmsxoQINc4fSijfbNIiGhcgvwjsjxVFJHUstK9L1T8OTKUjgloN0Y3CCJAaDdWRwgiQG,enr:-J24QG3ypT4xSu0gjb5PABCmVxZqBjVw9ca7pvsI8jl4KATYAnxBmfkaIuEqy9sKvDHKuNCsy57WwK9wTt2aQgcaDDyGAYiOoGAXgmlkgnY0gmlwhDbGmZaHb3BzdGFja4OFQgCJc2VjcDI1NmsxoQIeAK_--tcLEiu7HvoUlbV52MspE0uCocsx1f_rYvRenIN0Y3CCJAaDdWRwgiQG
      ## Interfaces
      - --rpc.addr=0.0.0.0
      - --rpc.port=9545
