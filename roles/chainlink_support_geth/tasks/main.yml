---
# Geth/Lighthouse support structure with host networking

- name: Open p2p ports for geth and lighthouse_version
  become: true
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    comment: "{{ item.comment }}"
  loop:
    - port: 30303
      comment: External - geth p2p
    - port: 9000
      comment: External - lighthouse p2p

- name: Add docker-compose and docker-data folders
  ansible.builtin.shell: "openssl rand -hex 32 | tr -d '\n' > jwtsecret"
  args:
    chdir: "{{ user_dir }}/docker-compose"
    creates: jwtsecret
    executable: /bin/bash

- name: Run geth container
  community.docker.docker_container:
    name: geth
    image: ethereum/client-go:{{ geth_version }}
    restart_policy: unless-stopped
    state: started
    stop_timeout: 600
    network_mode: host
    volumes:
      - "{{ user_dir }}/docker-compose/geth:/geth"
      - "{{ user_dir }}/docker-compose/jwtsecret:/geth/jwtsecret"
    command:
      # p2p
      - --port=30303
      # rpc
      - --http
      - --http.port=8545
      - --http.addr=0.0.0.0
      - --http.vhosts=*
      - --http.corsdomain=*
      - --ws
      - --ws.port=8546
      - --ws.addr=0.0.0.0
      - --ws.origins=*
      - --authrpc.addr=0.0.0.0
      - --authrpc.port=8551
      - --authrpc.vhosts=*
      - --authrpc.jwtsecret=/geth/jwtsecret
      # general
      - --ipcdisable
      - --state.scheme=path
      - --datadir=/geth
      - --rpc.gascap=0
      - --rpc.txfeecap=0

- name: Run lighthouse container
  community.docker.docker_container:
    name: lighthouse
    image: sigp/lighthouse:{{ lighthouse_version }}
    restart_policy: unless-stopped
    state: started
    stop_timeout: 600
    network_mode: host
    volumes:
      - "{{ user_dir }}/docker-compose/lighthouse:/root/.lighthouse"
      - "{{ user_dir }}/docker-compose/jwtsecret:/root/.lighthouse/jwtsecret"
    command:
      - /usr/local/bin/lighthouse
      - beacon
      - --network=mainnet
      - --http
      - --http-address=0.0.0.0
      - --execution-endpoint=http://localhost:8551
      - --execution-jwt=/root/.lighthouse/jwtsecret
      - --checkpoint-sync-url=https://mainnet.checkpoint.sigp.io
      - --disable-deposit-contract-sync
