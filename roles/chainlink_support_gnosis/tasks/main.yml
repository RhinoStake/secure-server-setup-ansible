---
# Gnosis Support with custom ports
# Ports:
#  - Nethermind:
#    - 60303 (p2p, public)
#    - 60545 (rpc, internal)
#  - Lighthouse:
#    - 60900 (p2p, public)

- name: Open p2p ports for nethermind and lighthouse Gnosis
  become: true
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    comment: "{{ item.comment }}"
  loop:
    - port: 60303
      comment: External - gnosis nethermind p2p
    - port: 60900
      comment: External - gnosis lighthouse p2p

- name: Add docker-compose and docker-data folders
  ansible.builtin.shell: "set -o pipefail && openssl rand -hex 32 | tr -d '\n' > jwtsecret"
  args:
    chdir: "{{ user_dir }}/docker-compose"
    creates: jwtsecret
    executable: /bin/bash

- name: Run nethermind container for Gnosis
  community.docker.docker_container:
    name: gnosis_nethermind
    image: nethermind/nethermind:{{ gnosis_nethermind_version }}
    restart_policy: unless-stopped
    state: started
    stop_timeout: 600
    pull: true
    ports:
      # p2p
      - 60303:30303/tcp
      - 60303:30303/udp
      # rpc
      - "{{ nebula_internal_ip_addr }}:60545:8545"
      - 127.0.0.1:60545:8545
    networks:
      - name: gnosis_net
    volumes:
      - "{{ user_dir }}/docker-compose/gnosis/nethermind:/data"
      - "{{ user_dir }}/docker-compose/jwtsecret:/jwtsecret"
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    command:
      - --config=gnosis
      - --datadir=/data
      - --log=INFO
      - --Sync.SnapSync=false
      - --JsonRpc.Enabled=true
      - --JsonRpc.Host=0.0.0.0
      - --JsonRpc.Port=8545
      - --JsonRpc.EnabledModules=[Web3,Eth,Subscribe,Net]
      - --JsonRpc.JwtSecretFile=/jwtsecret
      - --JsonRpc.EngineHost=0.0.0.0
      - --JsonRpc.EnginePort=8551
      - --Network.DiscoveryPort=30303
      - --HealthChecks.Enabled=false
      - --Pruning.CacheMb=2048
      - --JsonRpc.MaxBatchResponseBodySize=70000000 # Per RMN Documentation

- name: Run lighthouse container for Gnosis
  community.docker.docker_container:
    name: gnosis_lighthouse
    image: sigp/lighthouse:{{ gnosis_lighthouse_version }}
    restart_policy: unless-stopped
    state: started
    stop_timeout: 600
    pull: true
    networks:
      - name: gnosis_net
    ports:
      # p2p
      - 60900:9000/tcp # p2p
      - 60900:9000/udp # p2p
    volumes:
      - "{{ user_dir }}/docker-compose/gnosis/lighthouse:/data"
      - "{{ user_dir }}/docker-compose/jwtsecret:/jwtsecret"
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    command:
      - /usr/local/bin/lighthouse
      - beacon_node
      - --network=gnosis
      - --disable-upnp
      - --datadir=/data
      - --port=9000
      - --http
      - --http-address=0.0.0.0
      - --http-port=4000
      - --execution-endpoint=http://gnosis_nethermind:8551
      - --execution-jwt=/jwtsecret
      - --checkpoint-sync-url=https://checkpoint.gnosischain.com/
