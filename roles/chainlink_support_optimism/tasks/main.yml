---
# Optimism with op-node, op-geth.  Utilized snap-sync for sync
# Ports:
#  - Geth: 13303 (p2p - public), 13045 (rpc), 13046 (ws), 8551 (authrpc)
#  - Node: 9003 (p2p - public), 9545 (rpc)

- name: Register public ip
  ansible.builtin.uri:
    url: https://ipv4.icanhazip.com/
    return_content: true
  register: public_ip

- name: Ensure op-geth-data exists
  ansible.builtin.file:
    path: "{{ user_dir }}/docker-compose/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - optimism
    - optimism/op-geth-data

- name: Create jwtsecret if it does not exist
  ansible.builtin.shell: "openssl rand -hex 32 | tr -d '\n' > jwtsecret"
  args:
    chdir: "{{ user_dir }}/docker-compose"
    creates: jwtsecret
    executable: /bin/bash

- name: Create a network
  community.docker.docker_network:
    name: optimism_net

- name: Run op-geth container
  community.docker.docker_container:
    name: op-geth
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-geth:{{ op_geth_version }}
    restart_policy: unless-stopped
    state: started
    stop_timeout: 600
    pull: true
    networks:
      - name: optimism_net
    ports:
      # p2p
      - 13303:13303/tcp
      - 13303:13303/udp
      # rpc
      - 127.0.0.1:13045:8545
      - "{{ nebula_internal_ip_addr }}:13045:8545"
      - 127.0.0.1:13046:8546
      - "{{ nebula_internal_ip_addr }}:13046:8546"
      # metrics
      - 127.0.0.1:13060:6060
      - "{{ nebula_internal_ip_addr }}:13060:6060"
    volumes:
      - "{{ user_dir }}/docker-compose/optimism/op-geth-data:/op-geth-data"
      - "{{ user_dir }}/docker-compose/jwtsecret:/jwtsecret"
      - /etc/localtime:/etc/localtime:ro
    command:
      ## General
      - --datadir=/op-geth-data
      - --syncmode=snap
      - --op-network=op-mainnet
      ## Interfaces
      # Consensus Layer Engine API
      - --authrpc.addr=0.0.0.0
      - --authrpc.port=8551
      - --authrpc.vhosts=*
      - --authrpc.jwtsecret=/jwtsecret
      # HTTP/RPC
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.corsdomain=*"
      - --http.vhosts=*
      - --http.api=web3,debug,eth,txpool,net,engine
      # Websocket
      - --ws
      - --ws.addr=0.0.0.0
      - --ws.port=8546
      - --ws.origins=*
      - --ws.api=web3,debug,eth,txpool,net,engine
      # P2P
      - --port=13303
      - --discovery.port=13303
      # Metrics
      - --metrics
      - --metrics.addr=0.0.0.0
      - --metrics.port=6060
      - --metrics.expensive
      # Transaction & Chain Specific
      - --rollup.sequencerhttp=https://mainnet-sequencer.optimism.io
      - --rollup.disabletxpoolgossip=true
      - --rpc.gascap=0
      - --rpc.txfeecap=0
      - --ipcdisable

- name: Run op-node container
  community.docker.docker_container:
    name: op-node
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-node:{{ op_node_version }}
    restart_policy: unless-stopped
    state: started
    stop_timeout: 600
    pull: true
    networks:
      - name: optimism_net
    ports:
      # p2p
      - 9003:9003
      # rpc
      - 127.0.0.1:9545:9545
      - "{{ nebula_internal_ip_addr }}:9545:9545"
    volumes:
      - "{{ user_dir }}/docker-compose/jwtsecret:/jwtsecret"
      - /etc/localtime:/etc/localtime:ro
    command:
      ## General
      - op-node
      - --l1={{ ethereum_l1 }}
      - --l1.beacon={{ ethereum_l1_beacon }}
      - --l1.trustrpc
      - --l2=http://op-geth:8551
      - --l2.jwt-secret=/jwtsecret
      - --network=op-mainnet
      - --rollup.load-protocol-versions=true
      # Syncing
      - --syncmode=execution-layer
      - --l1.max-concurrency=64
      - --l1.rpc-rate-limit=0
      - --l1.rpc-max-batch-size=500
      # p2p
      - --p2p.advertise.ip={{ public_ip.content | trim }}
      ## Interfaces
      - --rpc.addr=0.0.0.0
      - --rpc.port=9545
