---
# Optimism structure with host networking
# Ports:
#  - Geth: 8545 (rpc), 8546 (ws), 8551 (authrpc)
#  - Node: 9003 (p2p - public), 9545 (rpc)

- name: Ensure op-geth-data exists
  ansible.builtin.file:
    path: "{{ user_dir }}/docker-compose/op-geth-data"
    state: directory
    mode: "0755"

- name: Create jwtsecret if it does not exist
  ansible.builtin.shell: "openssl rand -hex 32 | tr -d '\n' > jwtsecret"
  args:
    chdir: "{{ user_dir }}/docker-compose"
    creates: jwtsecret
    executable: /bin/bash

- name: Check if op-geth-data is populated
  ansible.builtin.find:
    paths: "{{ user_dir }}/docker-compose/op-geth-data"
    file_type: any
    hidden: false
  register: op_geth_data

- name: Download and extract snapshot
  when: op_geth_data.matched == 0
  block:
    - name: Download snapshot
      ansible.builtin.shell:
        cmd: "aria2c -x6 -d {{ user_dir }} -o op-geth-snapshot.tar.zst https://datadirs.optimism.io/mainnet-bedrock.tar.zst"

    - name: Extract snapshot
      ansible.builtin.shell: "tar -xf {{ user_dir }}/op-geth-snapshot.tar.zst -C {{ user_dir }}/docker-compose/op-geth-data"
      environment:
        PATH: "{{ path }}"

- name: Open p2p ports for op-node
  become: true
  community.general.ufw:
    rule: allow
    port: "{{ item.port }}"
    proto: "{{ item.proto }}"
    comment: "{{ item.comment }}"
  loop:
    - port: 9003
      proto: any
      comment: External - op-node p2p

- name: Run op-geth container
  community.docker.docker_container:
    name: op-geth
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-geth:{{ op_geth_version }}
    restart_policy: unless-stopped
    state: started
    stop_timeout: 600
    network_mode: host
    pull: true
    volumes:
      - "{{ user_dir }}/docker-compose/op-geth-data:/op-geth-data"
      - "{{ user_dir }}/docker-compose/jwtsecret:/jwtsecret"
      - /etc/localtime:/etc/localtime:ro
    command:
      ## General
      - --datadir=/op-geth-data
      - --syncmode=full
      - --snapshot=false
      - --op-network=op-mainnet
      ## Interfaces
      # Consensus Layer Engine API
      - --authrpc.addr=127.0.0.1
      - --authrpc.port=8551
      - --authrpc.vhosts=*
      - --authrpc.jwtsecret=/jwtsecret
      # HTTP/RPC
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.vhosts=*
      - --http.api=debug,eth,txpool,net,engine
      # Websocket
      - --ws
      - --ws.addr=0.0.0.0
      - --ws.port=8546
      - --ws.origins=*
      - --ws.api=debug,eth,txpool,net,engine
      # P2P
      - --port=30303
      - --nodiscover
      # Metrics
      - --metrics
      - --metrics.addr=0.0.0.0
      - --metrics.port=6060
      - --metrics.expensive
      # Transaction & Chain Specific
      - --maxpeers=0
      - --rollup.sequencerhttp=https://mainnet-sequencer.optimism.io
      - --rollup.disabletxpoolgossip
      - --rpc.gascap=0
      - --rpc.txfeecap=0
      - --ipcdisable

- name: Run op-node container
  community.docker.docker_container:
    name: op-node
    image: us-docker.pkg.dev/oplabs-tools-artifacts/images/op-node:{{ op_node_version }}
    restart_policy: unless-stopped
    state: started
    stop_timeout: 600
    network_mode: host
    pull: true
    volumes:
      - "{{ user_dir }}/docker-compose/jwtsecret:/jwtsecret"
      - /etc/localtime:/etc/localtime:ro
    command:
      ## General
      - op-node
      - --l1={{ ethereum_l1 }}
      - --l1.beacon={{ ethereum_l1_beacon }}
      - --l2=http://127.0.0.1:8551
      - --l2.jwt-secret=/jwtsecret
      - --network=op-mainnet
      - --rollup.load-protocol-versions=true
      ## Interfaces
      - --rpc.addr=0.0.0.0
      - --rpc.port=9545

- name: Prune unused docker containers and images
  community.docker.docker_prune:
    containers: true
    images: true
    networks: true
    volumes: true
    builder_cache: true
  register: prune_output

- name: Review prune output
  ansible.builtin.debug:
    var: prune_output
