---
# Polygon support structure with host networking.  This does not handle snapshots.
# curl -L https://snapshot-download.polygon.technology/snapdown.sh | bash -s -- --network mainnet --client bor --extract-dir bor_extract --validate-checksum false
# curl -L https://snapshot-download.polygon.technology/snapdown.sh | bash -s -- --network mainnet --client heimdall --extract-dir bor_extract --validate-checksum false
# Ports:
#  - Bor: 11703/tcp - public, 11745/tcp, 11746/tcp
#  - Heimdall: 11756/tcp - public, 11757/tcp
#  - HeimdallRest: 11717/tcp

- name: Build folder structure
  ansible.builtin.file:
    path: "{{ user_dir }}/docker-compose/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "polygon"
    - "polygon/bor"
    - "polygon/heimdall"

- name: Copy bor config
  ansible.builtin.template:
    src: "template/config.toml.j2"
    dest: "{{ user_dir }}/docker-compose/polygon/bor/config.toml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"

- name: Open appropriate firewall ports for bor and heimdall
  become: true
  community.general.ufw:
    rule: allow
    proto: tcp
    port: "{{ item.port }}"
    comment: "{{ item.comment }}"
  loop:
    - port: "{{ custom_port_prefix }}03"
      comment: p2p port for bor
    - port: "{{ custom_port_prefix }}56"
      comment: p2p port for heimdall

- name: Check if node has been initialized
  ansible.builtin.stat:
    path: "{{ user_dir }}/docker-compose/polygon/heimdall/config"
  register: node_initialized

- name: Init heimdall container
  when: not node_initialized.stat.exists
  community.docker.docker_container:
    name: "{{ consensus_container_name }}"
    image: 0xpolygon/heimdall:{{ consensus_container_version }}
    state: started
    network_mode: host
    stop_timeout: 600
    pull: true
    volumes:
      - "{{ user_dir }}/docker-compose/polygon/heimdall:/heimdall-home"
    command:
      - "init"
      - "--home=/heimdall-home"
      - "--chain=mainnet"

- name: Pull and run heimdall container
  community.docker.docker_container:
    name: "{{ consensus_container_name }}"
    image: 0xpolygon/heimdall:{{ consensus_container_version }}
    restart_policy: unless-stopped
    state: started
    network_mode: host
    stop_timeout: 600
    pull: true
    volumes:
      - "{{ user_dir }}/docker-compose/polygon/heimdall:/heimdall-home"
    command:
      - "start"
      - "--home=/heimdall-home"
      - "--chain=mainnet"

- name: Pull and run heimdallrest container
  community.docker.docker_container:
    name: "{{ consensus_container_name }}rest"
    image: 0xpolygon/heimdall:{{ consensus_container_version }}
    restart_policy: unless-stopped
    state: started
    network_mode: host
    stop_timeout: 600
    pull: true
    volumes:
      - "{{ user_dir }}/docker-compose/polygon/heimdall:/heimdall-home"
    command:
      - "rest-server"
      - "--home=/heimdall-home"
      - "--node=tcp://localhost:26657"
      - "--chain=mainnet"

- name: Pull and run bor container
  community.docker.docker_container:
    name: "{{ execution_container_name }}"
    image: 0xpolygon/bor:{{ execution_container_version }}
    restart_policy: unless-stopped
    state: started
    network_mode: host
    stop_timeout: 600
    pull: true
    volumes:
      - "{{ user_dir }}/docker-compose/polygon/bor:/bor-home"
    command:
      - "server"
      - "--config=/bor-home/config.toml"
      - "--bootnodes=enode://a7f59b918fe19b5448b6dfbb35d5096eaffcdf20050f41f442c4a72377f7634da10fe23b1a405f72f6146b3c78738160c98c2c47d60a81e489fa47a50fe8700c@77.172.185.210:30303,enode://b8f1cc9c5d4403703fbf377116469667d2b1823c0daf16b7250aa576bacf399e42c3930ccfcb02c5df6879565a2b8931335565f0e8d3f8e72385ecf4a4bf160a@3.36.224.80:30303,enode://8729e0c825f3d9cad382555f3e46dcff21af323e89025a0e6312df541f4a9e73abfa562d64906f5e59c51fe6f0501b3e61b07979606c56329c020ed739910759@54.194.245.5:30303,enode://dcafedac347b24aea85a4b396511dc7ba4da37cd2ce13de9511aba50879fe04e6e259ce6314ae3376c1e3cc2f1909273781a74e9c386bcec29f5b42d1db0fe14@47.76.152.221:30303"
      - "--db.engine=pebble"
      - "--state.scheme=path"
