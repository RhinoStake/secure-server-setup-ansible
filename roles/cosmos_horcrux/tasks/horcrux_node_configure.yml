---
- name: Create horcrux directory
  ansible.builtin.file:
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: directory
    path: "{{ horcrux_dir }}/state"
    mode: "0750"

- name: Create state files
  ansible.builtin.template:
    src: priv_validator_state.json
    dest: "{{ horcrux_dir }}/state/{{ chain_id }}_{{ item }}"
    mode: "0600"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    force: false
  with_items:
    - priv_validator_state.json
    - share_sign_state.json

- name: Copy config
  ansible.builtin.template:
    backup: true
    src: config.yaml
    dest: "{{ horcrux_dir }}/config.yaml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"
  tags: configs
  when: shares > 1

- name: Copy Single-Signer config
  ansible.builtin.template:
    backup: true
    src: single_config.yaml
    dest: "{{ horcrux_dir }}/config.yaml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"
  tags: configs
  when: shares == 1

- name: Copy horcrux service file
  ansible.builtin.template:
    src: "horcrux.service.j2"
    dest: "/etc/systemd/system/{{ service_file }}"
    owner: root
    group: root
    mode: 0600
  become: true
  register: systemdunit

- name: Enable systemd unit
  ansible.builtin.systemd:
    daemon_reload: true
    name: "{{ service_file }}"
    enabled: true
  become: true
  when: systemdunit.changed
