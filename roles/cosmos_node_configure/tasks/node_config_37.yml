---
# Configure for Tendermint 0.37+
- name: Read vars
  ansible.builtin.include_vars:
    file: ../vars/main.yml
    name: config_changes

- name: Register public ip
  ansible.builtin.uri:
    url: https://ipv4.icanhazip.com/
    return_content: true
  register: public_ip

- name: Set external address in config.toml
  ansible.builtin.lineinfile:
    path: "{{ user_dir }}/{{ folder }}/config/config.toml"
    regexp: 'external-address = "'
    line: 'external-address = "{{ public_ip.content | trim }}:{{ custom_port_prefix }}56"'
    state: present

- name: Adjust config.toml for generic items (config_toml_37)
  block:
    - name: Adjust null section
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/config.toml"
        section: null
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        mode: "0644"
      loop: '{{ config_changes.config_toml_37["no_section"] | dict2items }}'

    - name: Adjust rpc section
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/config.toml"
        section: rpc
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        mode: "0644"
      loop: '{{ config_changes.config_toml_37["rpc"] | dict2items }}'

    - name: Adjust p2p section
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/config.toml"
        section: p2p
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        mode: "0644"
      loop: '{{ config_changes.config_toml_37["p2p"] | dict2items }}'

    - name: Adjust instrumentation section
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/config.toml"
        section: instrumentation
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        mode: "0644"
      loop: '{{ config_changes.config_toml_37["instrumentation"] | dict2items }}'

- name: Adjust app.toml for generic items
  block:
    - name: Adjust api section
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/app.toml"
        section: api
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        mode: "0644"
      loop: '{{ config_changes.app_toml["api"] | dict2items }}'

    - name: Adjust grpc section
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/app.toml"
        section: grpc
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        mode: "0644"
      loop: '{{ config_changes.app_toml["grpc"] | dict2items }}'

    - name: Adjust grpc-web section
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/app.toml"
        section: grpc-web
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        mode: "0644"
      loop: '{{ config_changes.app_toml["grpc-web"] | dict2items }}'

    - name: Adjust state-commit section for Sei
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/app.toml"
        section: state-commit
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        mode: "0644"
      loop: '{{ config_changes.app_toml["state-commit"] | dict2items }}'

- name: Adjust pruning and state-sync settings for default pruning
  when: (rpc is undefined) and (archive is undefined)
  block:
    - name: Update pruning (default)
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/app.toml"
        section: null
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        create: false
      loop: '{{ config_changes.pruning_default["no_section"] | dict2items }}'

    - name: Update state-sync (default)
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/app.toml"
        section: state-sync
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        create: false
      loop: '{{ config_changes.pruning_default["state-sync"] | dict2items }}'

    - name: Disable state-store
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/app.toml"
        section: state-store
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        create: false
      loop: '{{ config_changes.state_store_disabled["state-store"] | dict2items }}'

- name: Adjust pruning and state-sync settings for rpc pruning
  when: (rpc is defined) and (archive is undefined)
  block:
    - name: Update pruning (rpc)
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/app.toml"
        section: null
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        create: false
      loop: '{{ config_changes.pruning_custom_rpc["no_section"] | dict2items }}'

    - name: Update state-sync (rpc)
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/app.toml"
        section: state-sync
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        create: false
      loop: '{{ config_changes.pruning_custom_rpc["state-sync"] | dict2items }}'

    - name: Enable state-store
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/app.toml"
        section: state-store
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        create: false
      loop: '{{ config_changes.state_store_enabled["state-store"] | dict2items }}'

- name: Adjust pruning and state-sync settings for archive
  when: archive is defined
  block:
    - name: Update pruning (archive)
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/app.toml"
        section: null
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        create: false
      loop: '{{ config_changes.pruning_nothing["no_section"] | dict2items }}'

    - name: Update state-sync (archive)
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/app.toml"
        section: state-sync
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        create: false
      loop: '{{ config_changes.pruning_nothing["state-sync"] | dict2items }}'

    - name: Enable state-store
      community.general.ini_file:
        path: "{{ user_dir }}/{{ folder }}/config/app.toml"
        section: state-store
        option: "{{ item.key }}"
        value: "{{ item.value }}"
        create: false
      loop: '{{ config_changes.state_store_enabled["state-store"] | dict2items }}'

- name: Set indexer to null for validator nodes
  when: (rpc is undefined) and (archive is undefined)
  ansible.builtin.lineinfile:
    path: "{{ user_dir }}/{{ folder }}/config/config.toml"
    regexp: "^indexer ="
    line: 'indexer = ["null"]'
    state: present
    backrefs: true

- name: Set indexer to kv for RPC and archive nodes
  when: (rpc is defined) or (archive is defined)
  ansible.builtin.lineinfile:
    path: "{{ user_dir }}/{{ folder }}/config/config.toml"
    regexp: "^indexer ="
    line: 'indexer = ["kv"]'
    state: present
    backrefs: true

- name: Set IAVL and related items (if present)
  ansible.builtin.lineinfile:
    path: "{{ user_dir }}/{{ folder }}/config/app.toml"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
    backrefs: true
  with_items:
    - { regexp: "^iavl-cache-size", line: "iavl-cache-size = 3906250" }
    - { regexp: "^memory_cache_size", line: "memory_cache_size = 8000" }
    - { regexp: "^query_gas_limit", line: "query_gas_limit = 10000000" }
    - {
        regexp: "^simulation_gas_limit",
        line: "simulation_gas_limit = 50000000",
      }

- name: Update minimum gas price on config file
  ansible.builtin.lineinfile:
    path: "{{ user_dir }}/{{ folder }}/config/app.toml"
    regexp: "^minimum-gas-prices ="
    line: 'minimum-gas-prices = "{{ minimum_gas_price }}"'
    state: present
  when: minimum_gas_price is defined

- name: Set signing port address for horcrux
  when: ( nebula_internal_ip_addr is defined ) and ( sentries is defined ) and ( nebula_internal_ip_addr in sentries )
  community.general.ini_file:
    path: "{{ user_dir }}/{{ folder }}/config/config.toml"
    section: priv-validator
    option: "{{ item.key }}"
    value: "{{ item.value }}"
    mode: "0644"
  loop: '{{ config_changes.config_toml_37["priv-validator"] | dict2items }}'
