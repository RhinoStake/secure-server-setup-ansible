---
# Install binary
- name: Install from source
  when: binary is undefined
  block:
    - name: Clone node repo
      ansible.builtin.git:
        repo: "{{ repo }}"
        dest: "{{ user_dir }}/source/{{ network }}"
        version: "{{ node_version }}"
        update: true
        force: true
        recursive: false

    - name: Change repo folder permission
      ansible.builtin.file:
        path: "{{ user_dir }}/source/{{ network }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        recurse: true
        mode: "0755"

    - name: Skip replace tendermint
      ansible.builtin.command: "{{ item }}"
      with_items:
        - "go mod edit -replace github.com/tendermint/tendermint=github.com/skip-mev/mev-tendermint@{{ skip_version }}"
        - "go mod tidy"
      args:
        chdir: "{{ user_dir }}/source/{{ network }}"
      environment:
        PATH: "{{ path }}"
        GOPATH: "{{ user_dir }}/go"
      when: skip_version is defined

    - name: Build and install node to go/bin folder
      ansible.builtin.command: "{{ item }}"
      args:
        chdir: "{{ user_dir }}/source/{{ network }}"
      with_items:
        # - "nice -n 15 make build"
        - "nice -n 15 make install"
      environment:
        PATH: "{{ path }}"
        GOPATH: "{{ user_dir }}/go"

- name: Install from binary
  ansible.builtin.include_tasks: binary_default.yml
  when: binary is defined and binary_processing is not defined

- name: Install from binary zipped
  ansible.builtin.include_tasks: binary_zip.yml
  when: binary is defined and binary_processing is defined and binary_processing == 'zip'

- name: Install from binary tar gz
  ansible.builtin.include_tasks: binary_targz.yml
  when: binary is defined and binary_processing is defined and binary_processing == 'targz'

- name: Install from binary tar bz2
  ansible.builtin.include_tasks: binary_tarbz2.yml
  when: binary is defined and binary_processing is defined and binary_processing == 'tarbz2'
