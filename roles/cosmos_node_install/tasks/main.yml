---
# Install binary
- name: Install from source
  block:
    - name: Clone node repo
      ansible.builtin.git:
        repo: "{{ repo }}"
        dest: "{{ user_dir }}/source/{{ network }}"
        version: "{{ node_version }}"
        update: true
        force: true
        recursive: false

    - name: Change repo folder permission
      ansible.builtin.file:
        path: "{{ user_dir }}/source/{{ network }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        recurse: true
        mode: "0755"

    - name: Add replacement for Skip enabled chains
      ansible.builtin.lineinfile:
        insertafter: replace \(
        line: '    github.com/tendermint/tendermint => github.com/skip-mev/mev-tendermint {{ skip_version }}'
        path: '{{ user_dir }}/source/{{ network }}/go.mod'
        state: present
      when: skip_version is defined

    - name: Go mod tidy for Skip enabled chains
      ansible.builtin.command: "go mod tidy"
      args:
        chdir: "{{ user_dir }}/source/{{ network }}"
      environment:
        PATH: "{{ path }}"
        GOPATH: "{{ user_dir }}/go"
      when: skip_version is defined

    - name: Build and install node to go/bin folder
      ansible.builtin.command: "{{ item }}"
      args:
        chdir: "{{ user_dir }}/source/{{ network }}"
      with_items:
        - "make build"
        - "make install"
      environment:
        PATH: "{{ path }}"
        GOPATH: "{{ user_dir }}/go"
  when: binary is undefined

- name: Install from binary
  include_tasks: binary_default.yml
  when: binary is defined and binary_processing is not defined

- name: Install from binary zipped
  include_tasks: binary_zip.yml
  when: binary is defined and binary_processing is defined and binary_processing == 'zip'

- name: Install from binary tar gz
  include_tasks: binary_targz.yml
  when: binary is defined and binary_processing is defined and binary_processing == 'targz'
