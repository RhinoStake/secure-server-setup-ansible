#!/bin/bash
# State_sync node via p2p

SNAP_HEIGHT_BUFFER=25000
STATE_SYNC_RPC="{{ snap_rpc }}"

LATEST_HEIGHT=$(curl -s $STATE_SYNC_RPC/block | jq -r .block.header.height)
SYNC_BLOCK_HEIGHT=$(($LATEST_HEIGHT - $SNAP_HEIGHT_BUFFER))
SYNC_BLOCK_HASH=$(curl -s "$STATE_SYNC_RPC/block?height=$SYNC_BLOCK_HEIGHT" | jq -r .block_id.hash)

echo -e "Modifying $HOME/{{ folder }}/config/config.toml based on the following values:"
echo -e "RPC Address:          <none>"
echo -e "Use p2p:              true"
echo -e "Latest Block Height:  $LATEST_HEIGHT"
echo -e "Sync Block Height:    $SYNC_BLOCK_HEIGHT"
echo -e "Trust Hash:           $SYNC_BLOCK_HASH"

sed -i.bak -e "s|^enable *=.*|enable = true|" $HOME/{{ folder }}/config/config.toml
sed -i.bak -e "s|^use-p2p *=.*|use-p2p = true|" $HOME/{{ folder }}/config/config.toml
sed -i.bak -e "s|^rpc-servers *=.*|rpc-servers = \"\"|" $HOME/{{ folder }}/config/config.toml
sed -i.bak -e "s|^trust-height *=.*|trust-height = $SYNC_BLOCK_HEIGHT|" $HOME/{{ folder }}/config/config.toml
sed -i.bak -e "s|^trust-hash *=.*|trust-hash = \"$SYNC_BLOCK_HASH\"|" $HOME/{{ folder }}/config/config.toml
