---
# For now this uses Polkachu's snapshot urls.  This will eventually need to be replaced
- name: Set URLs for retrieving items
  ansible.builtin.set_fact:
    snapshotpage_url: "{{ snapshotpage_url }}/{{ network }}"
    addrbookpage_url: "{{ addrbookpage_url }}/{{ network }}/addrbook.json"

- name: Parse Snapshot URL
  when: snapshot_url is not defined
  block:
    - name: Parse snapshot url from snapshot
      ansible.builtin.shell: 'curl -s {{ snapshotpage_url }} | grep ''<a href="https://snapshots'' | grep -Eo ''https.*tar.lz4'' | head -1'
      environment:
        PATH: "{{ path }}"
      register: snapshot_url_raw

    - name: Set fact
      ansible.builtin.set_fact:
        snapshot_url: "{{ snapshot_url_raw.stdout }}"

- name: Fail if snapshot_url not defined
  ansible.builtin.fail:
    msg: snapshot_url is not available
  when: snapshot_url == None

- name: Print snapshot_url
  ansible.builtin.debug:
    msg: "Downloading snapshot {{ snapshot_url }}"

- name: Download snapshot
  ansible.builtin.shell:
    cmd: "aria2c -x5 -d {{ user_dir }} -o {{ network }}-snapshot.tar.lz4 {{ snapshot_url }}"
  environment:
    PATH: "{{ path }}"

- name: Stop cosmovisor
  become: true
  ansible.builtin.systemd:
    name: "{{ daemon }}"
    state: stopped

- name: Pause for 5 seconds
  ansible.builtin.pause:
    seconds: 5

- name: Save the state file
  ansible.builtin.copy:
    src: "{{ user_dir }}/{{ folder }}/data/priv_validator_state.json"
    dest: "{{ user_dir }}/priv_validator_state.json"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0600"
    remote_src: true
    force: true

- name: Remove and create data folder
  ansible.builtin.file:
    path: "{{ user_dir }}/{{ folder }}/data"
    state: "{{ item }}"
    mode: "0755"
  with_items:
    - absent
    - directory

- name: Extract archive
  ansible.builtin.shell: "lz4 -c -d {{ user_dir }}/{{ network }}-snapshot.tar.lz4 | tar -x -C {{ user_dir }}/{{ folder }}"
  environment:
    PATH: "{{ path }}"

- name: Replace the state file
  ansible.builtin.copy:
    src: "{{ user_dir }}/priv_validator_state.json"
    dest: "{{ user_dir }}/{{ folder }}/data/priv_validator_state.json"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0600"
    remote_src: true
    force: true

- name: Ensure state-sync is disabled
  community.general.ini_file:
    path: "{{ user_dir }}/{{ folder }}/config/config.toml"
    section: statesync
    option: "enable"
    value: "false"
    create: false

- name: Start cosmovisor
  become: true
  ansible.builtin.systemd:
    name: "{{ daemon }}"
    state: restarted

- name: Cleanup temporary files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "{{ user_dir }}/{{ network }}-snapshot.tar.lz4"
    - "{{ user_dir }}/priv_validator_state.json"
