---
- name: Create state_sync directory
  ansible.builtin.file:
    path: "{{ user_dir }}/state_sync"
    state: directory
    mode: "0755"
  when: snap_rpc is defined

- name: Copy state_sync file
  ansible.builtin.template:
    src: "../cosmos_node_launch/templates/state_sync.sh.j2"
    dest: "{{ user_dir }}/state_sync/state_sync_{{ network }}.sh"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0700"
  when: snap_rpc is defined

- name: Verify state_sync exists for chain
  ansible.builtin.stat:
    path: "{{ user_dir }}/state_sync/state_sync_{{ network }}.sh"
  register: statesync

- name: Fail if file not found
  when: statesync.stat.exists == false
  ansible.builtin.fail:
    msg: "State sync file not present on node"

- name: Run state_sync script on node
  ansible.builtin.shell: "{{ user_dir }}/state_sync/state_sync_{{ network }}.sh"
  environment:
    PATH: "{{ path }}"

- name: Stop cosmovisor
  become: true
  ansible.builtin.systemd:
    name: "{{ daemon }}"
    state: stopped

- name: Reset data folder
  ansible.builtin.command: "{{ daemon }} tendermint unsafe-reset-all --home {{ user_dir }}/{{ folder }} --keep-addr-book"
  environment:
    PATH: "{{ path }}"

- name: Start cosmovisor
  become: true
  ansible.builtin.systemd:
    name: "{{ daemon }}"
    state: restarted
