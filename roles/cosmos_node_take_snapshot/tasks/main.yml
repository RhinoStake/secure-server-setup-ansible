---
- name: Add cosmprund repository
  ansible.builtin.git:
    repo: https://github.com/binaryholdings/cosmprund.git
    dest: /home/{{ ansible_user }}/source/cosmprund
    single_branch: true
    force: true
    version: "{{ cosmprund_version }}"

- name: Build cosmprund
  ansible.builtin.command: "{{ item }}"
  args:
    chdir: "{{ user_dir }}/source/cosmprund"
  with_items:
    - "make build"
  environment:
    PATH: "{{ path }}"
    GOPATH: "{{ user_dir }}/go"

- name: Copy cosmprund to directory
  ansible.builtin.copy:
    src: "{{ user_dir }}/source/cosmprund/build/cosmprund"
    dest: "{{ user_dir }}/go/bin/cosmprund"
    remote_src: true
    mode: "0755"

- name: Get current block height
  ansible.builtin.shell: "curl -sL http://localhost:{{ custom_port_prefix }}57/status | jq -r .result.sync_info.latest_block_height"
  register: currentheight

- name: Stop cosmovisor
  become: true
  ansible.builtin.systemd:
    name: "{{ daemon }}"
    state: stopped

- name: Pause for 5 seconds
  ansible.builtin.pause:
    seconds: 5

- name: Run cosmprund
  ansible.builtin.command:
    cmd: "{{ user_dir }}/go/bin/cosmprund prune ~/{{ folder }}/data"
    chdir: "{{ user_dir }}"
  environment:
    PATH: "{{ path }}"

- name: Check for external wasm
  ansible.builtin.stat:
    path: "{{ user_dir }}/{{ folder }}/wasm"
  register: wasm_outside

- name: Check for internal wasm
  ansible.builtin.stat:
    path: "{{ user_dir }}/{{ folder }}/data/wasm"
  register: wasm_inside

- name: Create archive - external wasm
  when: wasm_outside.stat.exists
  ansible.builtin.shell:
    cmd: "tar --exclude=wasm/wasm/cache -cf - data wasm | lz4 > {{ user_dir }}/{{ network }}-snapshot.{{ currentheight.stdout }}.tar.lz4"
    chdir: "{{ user_dir }}/{{ folder }}"
  environment:
    PATH: "{{ path }}"

- name: Create archive - internal wasm
  when: wasm_inside.stat.exists
  ansible.builtin.shell:
    cmd: "tar --exclude=data/wasm/wasm/cache -cf - data | lz4 > {{ user_dir }}/{{ network }}-snapshot.{{ currentheight.stdout }}.tar.lz4"
    chdir: "{{ user_dir }}/{{ folder }}"
  environment:
    PATH: "{{ path }}"

- name: Create archive - no wasm
  when: not wasm_inside.stat.exists and not wasm_outside.stat.exists
  ansible.builtin.shell:
    cmd: "tar -cf - data | lz4 > {{ user_dir }}/{{ network }}-snapshot.{{ currentheight.stdout }}.tar.lz4"
    chdir: "{{ user_dir }}/{{ folder }}"
  environment:
    PATH: "{{ path }}"

- name: Start cosmovisor
  become: true
  ansible.builtin.systemd:
    name: "{{ daemon }}"
    state: restarted

- name: Copy files to snapshot
  ansible.builtin.command:
    cmd: "rsync -av --progress {{ network }}-snapshot.{{ currentheight.stdout }}.tar.lz4 rsync://10.254.110.101/share/"
    chdir: "{{ user_dir }}"
  environment:
    PATH: "{{ path }}"

- name: Cleanup temporary files
  ansible.builtin.file:
    path: "{{ user_dir }}/{{ network }}-snapshot.{{ currentheight.stdout }}.tar.lz4"
    state: absent

- name: Print path
  ansible.builtin.debug:
    msg: "Snapshot uploaded to: https://share.rhinostake.com/{{ network }}-snapshot.{{ currentheight.stdout }}.tar.lz4"
