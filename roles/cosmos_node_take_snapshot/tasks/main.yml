---
- name: Get current block height
  ansible.builtin.shell: "curl -sL http://localhost:{{ custom_port_prefix }}57/status | jq -r .sync_info.latest_block_height"
  register: currentheight

- name: Stop cosmovisor
  become: true
  ansible.builtin.systemd:
    name: "{{ daemon }}"
    state: stopped

- name: Pause for 5 seconds
  ansible.builtin.pause:
    seconds: 5

- name: Check for external wasm
  ansible.builtin.stat:
    path: "{{ user_dir }}/{{ folder }}/wasm"
  register: wasm_outside

- name: Check for internal wasm
  ansible.builtin.stat:
    path: "{{ user_dir }}/{{ folder }}/data/wasm"
  register: wasm_inside

- name: Create archive - external wasm
  when: wasm_outside.stat.exists
  ansible.builtin.shell:
    cmd: "tar --exclude=wasm/wasm/cache -cf - data wasm | lz4 > {{ user_dir }}/{{ network }}-snapshot.{{ currentheight.stdout }}.tar.lz4"
    chdir: "{{ user_dir }}/{{ folder }}"
  environment:
    PATH: "{{ path }}"

- name: Create archive - internal wasm
  when: wasm_inside.stat.exists
  ansible.builtin.shell:
    cmd: "tar --exclude=data/wasm/wasm/cache -cf - data | lz4 > {{ user_dir }}/{{ network }}-snapshot.{{ currentheight.stdout }}.tar.lz4"
    chdir: "{{ user_dir }}/{{ folder }}"
  environment:
    PATH: "{{ path }}"

- name: Create archive - no wasm
  when: not wasm_inside.stat.exists and not wasm_outside.stat.exists
  ansible.builtin.shell:
    cmd: "tar -cf - data | lz4 > {{ user_dir }}/{{ network }}-snapshot.{{ currentheight.stdout }}.tar.lz4"
    chdir: "{{ user_dir }}/{{ folder }}"
  environment:
    PATH: "{{ path }}"

- name: Start cosmovisor
  become: true
  ansible.builtin.systemd:
    name: "{{ daemon }}"
    state: restarted

- name: Copy files to snapshot
  ansible.builtin.command:
    cmd: "rsync -av --progress {{ network }}-snapshot.{{ currentheight.stdout }}.tar.lz4 rsync://10.254.110.101/share/"
    chdir: "{{ user_dir }}"
  environment:
    PATH: "{{ path }}"

- name: Cleanup temporary files
  ansible.builtin.file:
    path: "{{ user_dir }}/{{ network }}-snapshot.{{ currentheight.stdout }}.tar.lz4"
    state: absent

- name: Print path
  ansible.builtin.debug:
    msg: "Snapshot uploaded to: https://share.rhinostake.com/{{ network }}-snapshot.{{ currentheight.stdout }}.tar.lz4"
