---
# Prep upgrade in cosmovisor
- name: Create cosmovisor upgrade directory
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  with_items:
    - "{{ user_dir }}/{{ folder }}/cosmovisor/upgrades/{{ upgrade_name }}/bin"

- name: Copy upgraded binary to upgrade directory
  ansible.builtin.copy:
    src: "{{ user_dir }}/go/bin/{{ daemon }}"
    dest: "{{ user_dir }}/{{ folder }}/cosmovisor/upgrades/{{ upgrade_name }}/bin"
    remote_src: true
    mode: "0755"

- name: Stat /tmp/libwasmvm.x86_64.so
  ansible.builtin.stat:
    path: "{{ user_dir }}/go/bin/libwasmvm.x86_64.so"
  register: libwasm

- name: Copy libwasmvm if exists
  when: libwasm.stat.exists
  ansible.builtin.copy:
    src: "{{ user_dir }}/go/bin/libwasmvm.x86_64.so"
    dest: "{{ user_dir }}/{{ folder }}/cosmovisor/upgrades/{{ upgrade_name }}/bin"
    mode: "0644"
    remote_src: true

- name: Save version
  ansible.builtin.command: "{{ user_dir }}/{{ folder }}/cosmovisor/upgrades/{{ upgrade_name }}/bin/{{ daemon }} version"
  register: version

- name: Confirm version
  ansible.builtin.debug:
    msg:
      - "Binary reported version: {{ version.stdout }} should match requested: {{ node_version }}."
      - "Binary installed into {{ user_dir }}/{{ folder }}/cosmovisor/upgrades/{{ upgrade_name }}/bin/"
