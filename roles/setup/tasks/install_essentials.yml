---
- name: Install essentials
  ansible.builtin.apt:
    name:
      - logrotate
      - ufw
      - chrony
      - htop
      - screen
      - build-essential
      - wget
      - curl
      - fio
      - vim
      - jq
      - tree
      - bc
      - prometheus-node-exporter
      - lz4
      - aria2
      - zip
      - net-tools
      - tuned
      - tuned-utils
      - tuned-utils-systemtap
      - tmux
      - vlan
      - nvme-cli
      - bash-completion
      - lsof
      - rsync
      - mdadm
      - dnsutils
      - apparmor-utils
    state: present
    update_cache: true
    cache_valid_time: 3600

# Set timezone to UTC
- name: Set timezone to UTC
  community.general.timezone:
    name: Etc/UTC

- name: Retrieve tuned profile
  ansible.builtin.slurp:
    src: "/etc/tuned/active_profile"
  register: active_profile

- name: Set tuned profile
  ansible.builtin.command: "/usr/sbin/tuned-adm profile {{ tuned }}"
  when: active_profile.content | b64decode | trim != tuned

- name: Set swappiness to 10
  ansible.posix.sysctl:
    name: vm.swappiness
    value: "10"
    state: present
    reload: true

- name: Add TOML vim plugin
  become: false
  ansible.builtin.git:
    repo: "https://github.com/cespare/vim-toml.git"
    dest: "{{ user_dir }}/.vim/pack/plugins/start/vim-toml"
    single_branch: true
    version: "main"

- name: Create source if it does not exist
  become: false
  ansible.builtin.file:
    path: "{{ user_dir }}/source"
    state: directory
    mode: "0755"
