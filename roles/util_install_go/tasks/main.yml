- name: Download go
  ansible.builtin.get_url:
    url: "https://golang.org/dl/{{ go_release }}"
    dest: "/tmp/{{ go_release }}"
    mode: "0700"
  register: goversion

- name: Install new go version
  block:
    - name: Remove go binary
      ansible.builtin.file:
        path: /usr/local/go
        state: absent
      become: true
      ignore_errors: true

    - name: Unarchive go release
      ansible.builtin.unarchive:
        src: /tmp/{{ go_release }}
        dest: /usr/local
        remote_src: true
      become: true
  when: goversion.changed

- name: Copy .zprofile
  ansible.builtin.template:
    src: "zprofile.j2"
    dest: "{{ user_dir }}/.zprofile"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0600"

- name: Change go folder permission
  ansible.builtin.file:
    path: "{{ user_dir }}/go"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    recurse: true
    mode: "0755"
