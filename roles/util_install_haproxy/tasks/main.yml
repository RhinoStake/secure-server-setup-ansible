---
- name: Install haproxy repository key
  become: true
  ansible.builtin.get_url:
    url: "https://haproxy.debian.net/bernat.debian.org.gpg"
    dest: /usr/share/keyrings/haproxy.debian.net.asc
    mode: "0644"
    force: true

- name: Install haproxy repository
  become: true
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/haproxy.debian.net.asc] http://haproxy.debian.net/ {{ ansible_distribution_release }}-backports-2.8 main"
    state: present
    update_cache: true

- name: Install haproxy
  become: true
  ansible.builtin.apt:
    name:
      - haproxy=2.8.*
    state: present
    update_cache: true
  notify: Restart haproxy

- name: Copy certificates
  become: true
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/etc/ssl/"
    owner: root
    group: root
    mode: "0644"
  notify: Restart haproxy
  with_fileglob: "templates/*.pem"

- name: Copy haproxy config
  become: true
  ansible.builtin.template:
    src: "haproxy-{{ haproxy_config }}.cfg"
    dest: "/etc/haproxy/haproxy.cfg"
    owner: root
    group: root
    mode: "0644"
  notify: Restart haproxy

- name: Copy check scripts
  become: true
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "/var/lib/haproxy/{{ item }}"
    owner: root
    group: root
    mode: "0755"
  loop:
    - eth_check.sh
    - sync_check.sh
    - sei_check.sh
  notify: Restart haproxy

- name: Stat local map file
  delegate_to: localhost
  ansible.builtin.stat:
    path: "{{ role_path }}/templates/haproxy-{{ haproxy_config }}.map"
  register: map_exists

- name: Stat local ws-map file
  delegate_to: localhost
  ansible.builtin.stat:
    path: "{{ role_path }}/templates/haproxy-{{ haproxy_config }}-ws.map"
  register: ws_map_exists

- name: Copy map file
  when: map_exists.stat.exists
  notify: Restart haproxy
  block:
    - name: Create map folder
      become: true
      ansible.builtin.file:
        path: "/etc/haproxy/maps"
        owner: root
        group: root
        mode: "0755"
        state: directory

    - name: Copy map file
      become: true
      ansible.builtin.template:
        src: "haproxy-{{ haproxy_config }}.map"
        dest: "/etc/haproxy/maps/host.map"
        owner: root
        group: root
        mode: "0644"

    - name: Copy ws-map file
      when: ws_map_exists.stat.exists
      become: true
      ansible.builtin.template:
        src: "haproxy-{{ haproxy_config }}-ws.map"
        dest: "/etc/haproxy/maps/host-ws.map"
        owner: root
        group: root
        mode: "0644"

- name: Test haproxy config
  ansible.builtin.command: /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -c

- name: Open http ports in ufw
  become: true
  community.general.ufw:
    rule: allow
    proto: tcp
    port: "{{ item }}"
    comment: External - haproxy
  loop:
    - 443
