---
- name: Register installed ipfs version
  ansible.builtin.shell: '/usr/local/bin/ipfs version | cut -d " " -f3'
  register: ipfsversion
  ignore_errors: true

- name: Download and install ipfs
  when: ipfsversion.stdout != ipfs_release
  notify: Restart ipfs service
  block:
    - name: Download ipfs
      ansible.builtin.get_url:
        url: "https://dist.ipfs.tech/kubo/v{{ ipfs_release }}/kubo_v{{ ipfs_release }}_linux-amd64.tar.gz"
        dest: "{{ user_dir }}/source/kubo_v{{ ipfs_release }}_linux-amd64.tar.gz"
        mode: "0700"

    - name: Unarchive ipfs release
      ansible.builtin.unarchive:
        src: "{{ user_dir }}/source/kubo_v{{ ipfs_release }}_linux-amd64.tar.gz"
        dest: "{{ user_dir }}/source"
        remote_src: true

    - name: Install ipfs release
      become: true
      ansible.builtin.copy:
        src: "{{ user_dir }}/source/kubo/ipfs"
        dest: "/usr/local/bin"
        owner: root
        group: root
        mode: "0755"
        remote_src: true
        force: true

    - name: Delete temporary files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "{{ user_dir }}/source/kubo_v{{ ipfs_release }}_linux-amd64.tar.gz"
        - "{{ user_dir }}/source/kubo/"

- name: Check if node has been initialized
  ansible.builtin.stat:
    path: "{{ user_dir }}/.ipfs"
  register: node_initialized

- name: Init ipfs node
  when: not node_initialized.stat.exists
  ansible.builtin.command: "ipfs init --empty-repo --profile server"
  args:
    creates: "{{ user_dir }}/.ipfs/config"
  environment:
    PATH: "{{ path }}"

- name: IPFS config via cli, including node bootstrap
  ansible.builtin.command: "{{ item }}"
  environment:
    PATH: "{{ path }}"
  with_items:
    - ipfs config Addresses.Gateway /ip4/0.0.0.0/tcp/8080
    - ipfs config Addresses.API /ip4/0.0.0.0/tcp/5001
    - ipfs config Datastore.Bloomfilter 1048576
    - ipfs bootstrap add /ip4/15.204.183.107/tcp/4001/p2p/12D3KooWSK5sr9g4uHWSmwaB7jLvKveDkt5U4fy4JRpVrzSWRpGM
    - ipfs bootstrap add /ip4/15.204.183.107/udp/4001/quic/p2p/12D3KooWSK5sr9g4uHWSmwaB7jLvKveDkt5U4fy4JRpVrzSWRpGM
    - ipfs config --json Peering.Peers '[{"ID":"Qma8ddFEQWEU8ijWvdxXm3nxU7oHsRtCykAaVz8WUYhiKn","Addrs":["/dnsaddr/production-ipfs-peer.pinata.cloud"]},{"ID":"12D3KooWKd92H37a8gCDZPDAAGTYvEGAq7CNk1TcaCkcZedkTwFG","Addrs":["/ip4/147.75.85.47/tcp/4001"]},{"ID":"12D3KooWGGyvEomXVi5YHqXdfGHx1GKHjVrUo313pWCs5uSfkoHK","Addrs":["/ip4/145.40.89.165/tcp/4001"]}]'

- name: IPFS StorageMax if recent node
  ansible.builtin.command: "{{ item }}"
  when: ipfs_role == "recent"
  environment:
    PATH: "{{ path }}"
  with_items:
    - "ipfs config Datastore.StorageMax 200GB"

- name: IPFS StorageMax if archive node
  ansible.builtin.command: "{{ item }}"
  when: ipfs_role == "archive"
  environment:
    PATH: "{{ path }}"
  with_items:
    - "ipfs config Datastore.StorageMax 4000GB"

- name: Open ipfs p2p port in ufw
  become: true
  community.general.ufw:
    rule: allow
    proto: tcp
    port: "4001"

- name: Increase UDP Receive Buffer Size
  become: true
  ansible.posix.sysctl:
    name: net.core.rmem_max
    value: 2500000
    state: present
    sysctl_set: true

- name: Copy service file
  notify: Restart ipfs service
  become: true
  ansible.builtin.template:
    src: "ipfs.service.j2"
    dest: "/etc/systemd/system/ipfs.service"
    owner: root
    group: root
    mode: "0644"
