- name: Download ipfs
  register: ipfsversion
  ansible.builtin.get_url:
    url: "https://dist.ipfs.tech/kubo/{{ ipfs_release }}/kubo_{{ ipfs_release }}_linux-amd64.tar.gz"
    dest: "{{ user_dir }}/source/kubo_{{ ipfs_release }}_linux-amd64.tar.gz"
    mode: "0700"

- name: Install ipfs daemon
  when: ipfsversion.changed
  block:
    - name: Unarchive ipfs release
      ansible.builtin.unarchive:
        src: "{{ user_dir }}/source/kubo_{{ ipfs_release }}_linux-amd64.tar.gz"
        dest: "{{ user_dir }}/source"
        remote_src: true

    - name: Install ipfs release
      become: true
      ansible.builtin.copy:
        src: "{{ user_dir }}/source/kubo/ipfs"
        dest: "/usr/local/bin"
        owner: root
        group: root
        mode: "0755"
        remote_src: true
        force: true

- name: Check if node has been initialized
  ansible.builtin.stat:
    path: "{{ user_dir }}/.ipfs"
  register: node_initialized

- name: Init ipfs node
  when: not node_initialized.stat.exists
  ansible.builtin.command: "ipfs init --empty-repo --profile server"
  args:
    creates: "{{ user_dir }}/.ipfs/config"
  environment:
    PATH: "{{ path }}"

- name: IPFS config via cli, including star-eastna-03 node bootstrap
  ansible.builtin.command: "{{ item }}"
  environment:
    PATH: "{{ path }}"
  with_items:
    - "ipfs config Addresses.Gateway /ip4/0.0.0.0/tcp/8080"
    - "ipfs config Addresses.API /ip4/0.0.0.0/tcp/5001"
    - "ipfs config Datastore.Bloomfilter 1048576"
    - "ipfs bootstrap add /ip4/15.204.183.107/tcp/4001/p2p/12D3KooWSK5sr9g4uHWSmwaB7jLvKveDkt5U4fy4JRpVrzSWRpGM"
    - "ipfs bootstrap add /ip4/15.204.183.107/udp/4001/quic/p2p/12D3KooWSK5sr9g4uHWSmwaB7jLvKveDkt5U4fy4JRpVrzSWRpGM"

- name: IPFS StorageMax if recent node
  ansible.builtin.command: "{{ item }}"
  when: ipfs_role == "recent"
  environment:
    PATH: "{{ path }}"
  with_items:
    - "ipfs config Datastore.StorageMax 200GB"

- name: IPFS StorageMax if archive node
  ansible.builtin.command: "{{ item }}"
  when: ipfs_role == "archive"
  environment:
    PATH: "{{ path }}"
  with_items:
    - "ipfs config Datastore.StorageMax 2000GB"

- name: Open ipfs p2p port in ufw
  become: true
  community.general.ufw:
    rule: allow
    proto: tcp
    port: "4001"

- name: Increase UDP Receive Buffer Size
  become: true
  ansible.posix.sysctl:
    name: net.core.rmem_max
    value: 2500000
    state: present
    sysctl_set: true

- name: Copy service file
  become: true
  ansible.builtin.template:
    src: "ipfs.service.j2"
    dest: "/etc/systemd/system/ipfs.service"
    owner: root
    group: root
    mode: "0644"

- name: Enable ipfs service
  become: true
  ansible.builtin.systemd:
    name: "ipfs"
    daemon_reload: true
    enabled: true
    state: restarted
