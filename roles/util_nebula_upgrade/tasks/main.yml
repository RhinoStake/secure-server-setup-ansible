- name: Get Nebula version
  ansible.builtin.command: "/etc/nebula/nebula -version"
  register: installed_nebula_version_out

- name: Extract Nebula version from command output
  ansible.builtin.set_fact:
    installed_nebula_version: "{{ installed_nebula_version_out.stdout.split(' ')[1] }}"

- name: Download & Extract Nebula
  when: (installed_nebula_version|default(nebula_version) != nebula_version)
  block:
    - name: Download binary
      ansible.builtin.unarchive:
        src: "https://github.com/slackhq/nebula/releases/download/v{{ nebula_version }}/nebula-linux-amd64.tar.gz"
        dest: "/etc/nebula"
        remote_src: true
      notify: Restart nebula

    - name: Ensure Nebula binaries permissions are correct
      ansible.builtin.file:
        path: "/etc/nebula/{{ item }}"
        owner: root
        group: root
        mode: "0700"
      with_items:
        - nebula
        - nebula-cert
